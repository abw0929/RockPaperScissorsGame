<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title></title>
    <style>

        html, body, canvas {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }

        .noGap {
            margin: 0px;
            padding: 0px;
        }

    </style>
</head>
<body>

    <canvas id="cvMain"></canvas>
    <div id="divNewPlayer" class="noGap" style="width: 300px; padding: 10px; border: 1px solid grey; background-color: white; position: absolute; top: 200px; left: calc(50% - 160px);">
        玩家名字：<input id="ipName" type="text" /><br />
        玩家性別：<input id="ipGenderMale" name="ipGender" type="radio" value="Male" checked="checked" />男
                  <input id="ipGenderFemale" name="ipGender" type="radio" value="Female" />女<br />
        頭髮顏色：<input id="ipHairColor" type="color" /><br />
        衣服顏色：<input id="ipBodyColor" type="color" /><br />
        <br />
        <input id="ipStartGame" type="button" value="開始遊戲" onclick="onStartGame();" />
        <label id="lbStartGameMsg" style="color: red;"></label>
    </div>
    <div id="divHistory" class="noGap" style="width: 300px; position: absolute; top: 10px; left: 10px; display: none;"></div>
    <div id="divChat" class="noGap" style="width: 300px; position: absolute; bottom: 40px; left: 20px; display: none;">
        <input id="ipChatMessage" type="text" style="width: 200px;" maxlength="60" />&nbsp;&nbsp;
        <input id="ipChatSend" type="button" value="送出" onclick="onSendChat();" />
    </div>
    
    <script src="Scripts/jquery-3.3.1.min.js"></script>
    <script>
        var socket;
        var allPlayers = [];
        var allPlayersMap = {};
        var allTalksMap = {};

        var canvas = document.getElementById("cvMain");
        var context = canvas.getContext("2d");
        var rerender = false;

        var gameState = "none";

        var moveSpeed = 5;
        var moveUp = false;
        var moveDown = false;
        var moveLeft = false;
        var moveRight = false;

        var roomW = 1000;
        var roomH = 1000;

        var myX = 500;
        var myY = 500;

        $(function () {
            onResize();
            initSocket();
        });

        function initSocket() {
            socket = new WebSocket("ws://teach.itpison.com/MyChatRoom/WebSocketServer.ashx");

            socket.addEventListener("open", function (evt) {
                gameState = "connected";
                $("#divHistory").prepend('Connection Opened with the server.<br />');
            }, false);

            socket.addEventListener("close", function (evt) {
                gameState = "disconnected";
                $("#divHistory").prepend('Connection was closed. :' + evt.reason + '<br />');
            }, false);

            socket.addEventListener("message", function (evt) {
                onMessage(JSON.parse(evt.data));
            }, false);

            socket.addEventListener("error", function (evt) {
                gameState = "disconnected";
                $("#divHistory").prepend('Error : ' + evt.message + '<br />');
            }, false);
        }

        function onMessage(data) {
            switch (data.Header) {
                case "NewPlayer":
                    onNewPlayer(data);
                    $("#divHistory").prepend(data.Player.Name + ' has entered the game.<br />');
                    break;
                case "NewPlayerOK":
                    gameState = "gaming";
                    $("#divNewPlayer").fadeOut(200);
                    $("#divChat").fadeIn(200);
                    break;
                case "NewPlayerFail":
                    $("#lbStartGameMsg").text('腳色名稱重複');
                    break;
                case "AllPlayers":
                    onAllPlayers(data);
                    $("#divHistory").prepend('Received all players. Count:' + allPlayers.length + '.<br />');
                    break;
                case "Talk":
                    onTalk(data);
                    $("#divHistory").prepend(data.Name + ': ' + data.Message + '.<br />');
                    break;
                case "Move":
                    onPlayerMove(data);
                    break;
                case "GameOver":
                    onGameOver(data);
                    $("#divHistory").prepend(data.Player.Name + ' has left the game.<br />');
                    break;
            }
        }

        function onStartGame() {
            if (gameState === "connected") {
                send({
                    Header: "NewPlayer",
                    Player: {
                        Name: $("#ipName").val(),
                        Gender: $('input[name=ipGender]:checked').val(),
                        HairColor: $("#ipHairColor").val(),
                        BodyColor: $("#ipBodyColor").val(),
                        Score: "0",
                        IsMe: "False",
                        Pos: { X: myX, Y: myY }
                    }
                });
            }
        }

        function onSendChat() {
            if (gameState === "gaming") {
                send({
                    Header: "Talk",
                    Message: $("#ipChatMessage").val()
                });
                $("#ipChatMessage").val("");
                $("#ipChatMessage").blur();
                $("#cvMain").focus();
            }
        }

        function onAllPlayers(data) {
            var players = data.Players;
            allPlayers = players;
            for (var i = 0; i < players.length; i++) {
                allPlayersMap[players[i].Id] = players[i];
            }
            rerender = true;
        }

        function onNewPlayer(data) {
            var player = data.Player;
            if (!allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id] = player;
                allPlayers.push(player);
                rerender = true;
            }
        }

        function onPlayerMove(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id].Pos = data.To;
                rerender = true;
            }
        }

        function onTalk(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id].Message = data.Message;
                rerender = true;
            }
        }

        function onGameOver(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                delete allPlayersMap[data.Id];
                var index = allPlayers.map(function (e) { return e.Id; }).indexOf(data.Id);
                allPlayers.splice(index, 1);
                rerender = true;
            }
        }

        setInterval(function () {
            if (gameState !== "gaming")
                return;

            if (rerender)
                renderMain();
            movePlayer();

        }, 40);

        window.onkeydown = onKeyDown;
        window.onkeyup = onKeyUp;
        window.onresize = onResize;

        function renderMain() {

            var transX = canvas.width / 2 - myX;
            var transY = canvas.height / 2 - myY;

            context.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
            context.translate(transX, transY);
            context.beginPath();
            context.rect(0, 0, roomW, roomH);
            context.stroke();

            sortPlayersByY();

            for (var i = 0; i < allPlayers.length; i++) {
                var player = allPlayers[i];
                drawPlayer(player);
            }

            context.setTransform(1, 0, 0, 1, 0, 0);

            rerender = false;
        }

        function sortPlayersByY() {
            allPlayers.sort(
                function (a, b) {
                    if (a.Pos.Y < b.Pos.Y)
                        return -1;
                    if (a.Pos.Y > b.Pos.Y)
                        return 1;
                    return 0;
                }
            );
        }

        function drawPlayer(player) {
            var x = player.Pos.X;
            var y = player.Pos.Y;
            //context.filter = "drop-shadow(0px 0px 4px black)";
            context.fillStyle = "black";
            context.fillRect(x - 6, y - 19, 12, 17);
            context.fillRect(x - 8, y - 33, 16, 16); // outline
            if (player.Gender === "Female") {
                context.fillRect(x - 10, y - 33, 5, 22);  // outline
            }

            context.fillStyle = player.BodyColor;
            context.fillRect(x - 5, y - 18, 10, 15); // body
            context.fillStyle = "#fff1c1";
            context.fillRect(x - 7, y - 32, 14, 14); // face
            context.fillStyle = "black";
            context.fillRect(x - 4, y - 3, 1, 3);
            context.fillRect(x + 3, y - 3, 1, 3);    // legs
            //context.filter = "none";
            context.fillStyle = player.HairColor;
            context.fillRect(x - 7, y - 32, 14, 5);  // hair
            if (player.Gender === "Female") {
                context.fillRect(x - 9, y - 32, 3, 20);  // hair
            }
            context.fillStyle = "black";
            context.fillRect(x - 4, y - 24, 1, 2);
            context.fillRect(x + 3, y - 24, 1, 2);   // eyes

            if (player.IsMe === "True")
                context.fillStyle = "red";
            else
                context.fillStyle = "black";
            context.fillText(player.Name, x - 15, y + 15);

            if (player.Message !== null && player.Message.trim() !== "") {
                var text = player.Message;
                var w = context.measureText(text).width;

                context.fillStyle = "white";
                context.fillRect(x - 25, y - 75, w + 10, 25);

                context.fillStyle = "black";
                context.fillText(text, x - 20, y - 60);

                context.beginPath();
                context.rect(x - 25, y - 75, w + 10, 25);
                context.stroke();
            }
        }

        function onKeyDown(event) {
            if (gameState !== "gaming")
                return;

            if (event.keyCode === 37) { // 左
                moveLeft = true;
            }else if (event.keyCode === 39) { // 右
                moveRight = true;
            }
            if (event.keyCode === 38) { // 上
                moveUp = true;
            } else if (event.keyCode === 40) { // 下
                moveDown = true;
            }

            if (event.keyCode === 13) {
                onSendChat();
            }
        }

        function onKeyUp(event) {
            if (gameState !== "gaming")
                return;

            if (event.keyCode == 37) { // 左
                moveLeft = false;
            }
            if (event.keyCode == 39) { // 右
                moveRight = false;
            }
            if (event.keyCode == 38) { // 上
                moveUp = false;
            }
            if (event.keyCode == 40) { // 下
                moveDown = false;
            }
        }

        function onResize(event) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            if (gameState === "gaming")
                renderMain();
        }

        function movePlayer() {
            if (!moveLeft && !moveRight && !moveUp && !moveDown)
                return;

            var myFrom = { X: myX, Y: myY };
            var myTo = {};
            var moved = false;

            if (moveLeft && myX > 20) {
                myX -= moveSpeed;
                moved = true;
            } else if (moveRight && myX < roomW - 20) {
                myX += moveSpeed;
                moved = true;
            }
            if (moveUp && myY > 20) {
                myY -= moveSpeed;
                moved = true;
            } else if (moveDown && myY < roomH - 20) {
                myY += moveSpeed;
                moved = true;
            }

            myTo = { X: myX, Y: myY };

            if (moved) {
                send({
                    Header: "Move",
                    From: myFrom,
                    To: myTo
                });
            }
        }

        function send(obj) {
            socket.send(JSON.stringify(obj));
        }

    </script>
</body>
</html>