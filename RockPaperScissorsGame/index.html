<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">-->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title></title>
    <style>

        html, body {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }

        #divJoyStick {
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            z-index: 1;
        }

        .noGap {
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>
<body>

    <div id="divJoyStick" style="display: none;"></div>
    <canvas id="cvMain" style="position: absolute; top: 0;"></canvas>
    <div id="divNewPlayer" class="noGap" style="width: 300px; padding: 10px; border: 1px solid grey; background-color: white; position: absolute; top:  calc(50% - 80px); left: calc(50% - 160px); z-index: 3;">
        玩家名字：<input id="ipName" type="text" maxlength="30" /><br />
        玩家性別：<input id="ipGenderMale" name="ipGender" type="radio" value="Male" checked="checked" />男
                  <input id="ipGenderFemale" name="ipGender" type="radio" value="Female" />女<br />
        頭髮顏色：<input id="ipHairColor" type="color" /><br />
        衣服顏色：<input id="ipBodyColor" type="color" /><br />
        <br />
        <input id="ipStartGame" type="button" value="開始遊戲" onclick="sendStartGame();" />
        <label id="lbStartGameMsg" style="color: red;"></label>
    </div>
    <div id="divHistoryFrame" class="noGap" style="width: 300px; height: 150px; overflow-x: hidden; overflow-y: auto;position: absolute; top: 10px; left: 10px; z-index: 2;">
        <div id="divHistory" class="noGap" style="width: 300px; word-wrap: break-word;"></div>
    </div>
    <div id="divChat" class="noGap" style="width: 300px; position: absolute; bottom: 40px; left: 20px; display: none; z-index: 3;">
        <input id="ipChatMessage" type="text" style="width: 200px;" maxlength="60" />&nbsp;&nbsp;
        <input id="ipChatSend" type="button" value="送出" onclick="sendChat();" />
    </div>
    
    <script src="Scripts/jquery-3.3.1.min.js"></script>
    <script src="Scripts/virtualjoystick.js"></script>
    <script>
        var socket;
        var myId;
        var allPlayers = [];
        var allPlayersMap = {};
        var allTalksMap = {};

        var canvas = document.getElementById("cvMain");
        var context = canvas.getContext("2d");
        var rerender = false;

        var gameState = "none";

        var moveSpeed = 5;
        var moveUp = false;
        var moveDown = false;
        var moveLeft = false;
        var moveRight = false;

        var roomW = 1000;
        var roomH = 1000;

        var myX = 0;
        var myY = 0;
        var myReceiveX = 0;
        var myReceiveY = 0;

        var joystick = new VirtualJoystick({
            container: document.getElementById('divJoyStick'),
            mouseSupport: true,
        });

        $(function () {
            onResize();
            randomPlayer();
            initSocket();
        });

        function initSocket() {
            socket = new WebSocket("ws://teach.itpison.com/MyChatRoom/WebSocketServer.ashx");

            socket.addEventListener("open", function (evt) {
                gameState = "connected";
                writeMessage('Connection Opened with the server.');
            }, false);

            socket.addEventListener("close", function (evt) {
                gameState = "disconnected";
                writeMessage('Connection was closed.' + evt.reason);
                resetGame();
            }, false);

            socket.addEventListener("message", function (evt) {
                onMessage(JSON.parse(evt.data));
            }, false);

            socket.addEventListener("error", function (evt) {
                gameState = "disconnected";
                writeMessage('Error.' + evt.message);
            }, false);
        }

        function randomPlayer() {
            $("#ipHairColor").val(getRandomColor());
            $("#ipBodyColor").val(getRandomColor());
        }

        function resetGame() {
            myId = "";
            gameState = "none";
            $("#divNewPlayer").fadeIn(200);
            $("#divChat").fadeOut(200);
            $("#divJoyStick").hide();

            context.clearRect(0, 0, canvas.width, canvas.height);
            rerender = true;
        }

        function onMessage(data) {
            switch (data.Header) {
                case "NewPlayer":
                    onNewPlayer(data);
                    break;
                case "NewPlayerOK":
                    onNewPlayerOK(data);
                    break;
                case "NewPlayerFail":
                    onNewPlayerFail(data);
                    break;
                case "AllPlayers":
                    onAllPlayers(data);
                    break;
                case "Talk":
                    onTalk(data);
                    break;
                case "Move":
                    onPlayerMove(data);
                    break;
                case "GameOver":
                    onGameOver(data);
                    break;
            }
        }

        function sendStartGame() {

            if (gameState !== "connected" && socket.readyState === socket.CLOSED) {
                initSocket();
            }

            if (gameState === "connected" && $("#ipName").val() !== "") {

                var myPos = getRandomPos();
                myX = myReceiveX = myPos.X;
                myY = myReceiveY = myPos.Y;

                send({
                    Header: "NewPlayer",
                    Player: {
                        Name: $("#ipName").val(),
                        Gender: $('input[name=ipGender]:checked').val(),
                        HairColor: $("#ipHairColor").val(),
                        BodyColor: $("#ipBodyColor").val(),
                        Score: "0",
                        IsMe: "False",
                        Pos: myPos,
                    }
                });
            }
        }

        function sendChat() {
            if (gameState === "gaming" && $("#ipChatMessage").val() !== "") {
                send({
                    Header: "Talk",
                    Message: $("#ipChatMessage").val()
                });
                $("#ipChatMessage").val("");
            }
        }

        function onAllPlayers(data) {
            var players = data.Players;
            allPlayers = players;
            for (var i = 0; i < players.length; i++) {
                allPlayersMap[players[i].Id] = players[i];
            }

            writeMessage('Received all players. Count:' + allPlayers.length + '.');

            rerender = true;
        }

        function onNewPlayer(data) {
            var player = data.Player;
            if (!allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id] = player;
                allPlayers.push(player);
                rerender = true;
            }

            writeMessage(data.Player.Name + ' has entered the game.');
        }

        function onNewPlayerOK(data) {
            gameState = "gaming";
            myId = data.Id;
            $("#divNewPlayer").fadeOut(200);
            $("#divChat").fadeIn(200);
            $("#divJoyStick").show();
        }

        function onNewPlayerFail(data) {
            $("#lbStartGameMsg").text('腳色名稱重複');
        }

        function onPlayerMove(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id].Pos = data.To;
                if (data.Id === myId) {
                    myReceiveX = data.To.X;
                    myReceiveY = data.To.Y;
                }
                rerender = true;
            }
        }

        function onTalk(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                allPlayersMap[data.Id].Message = data.Message;
                rerender = true;
            }
            writeMessage(data.Name + ': ' + data.Message + '.');
        }

        function onGameOver(data) {
            if (allPlayersMap.hasOwnProperty(data.Id)) {
                delete allPlayersMap[data.Id];
                var index = allPlayers.map(function (e) { return e.Id; }).indexOf(data.Id);
                allPlayers.splice(index, 1);
                rerender = true;
            }
            writeMessage(data.Player.Name + ' has left the game.');
        }

        setInterval(function () {
            if (gameState !== "gaming")
                return;

            if (rerender)
                renderMain();

            movePlayer();

        }, 40);

        window.onkeydown = onKeyDown;
        window.onkeyup = onKeyUp;
        window.onresize = onResize;

        function renderMain() {

            var transX = canvas.width / 2 - myReceiveX;
            var transY = canvas.height / 2 - myReceiveY;

            context.clearRect(0, 0, canvas.width, canvas.height);
            context.translate(transX, transY);

            context.beginPath();
            context.strokeStyle = "lightgrey";
            for (var i = 1; i < roomW / 100; i++) {
                context.moveTo(i * 100, 0);
                context.lineTo(i * 100, roomH);
            }
            for (var i = 1; i < roomH / 100; i++) {
                context.moveTo(0, i * 100);
                context.lineTo(roomW, i * 100);
            }
            context.stroke();

            context.beginPath();
            context.strokeStyle = "black";
            context.rect(0, 0, roomW, roomH);
            context.stroke();

            sortPlayersByY();

            for (var i = 0; i < allPlayers.length; i++) {
                var player = allPlayers[i];
                drawPlayer(player);
            }

            context.setTransform(1, 0, 0, 1, 0, 0);

            rerender = false;
        }

        function sortPlayersByY() {
            allPlayers.sort(
                function (a, b) {
                    if (a.Pos.Y < b.Pos.Y)
                        return -1;
                    if (a.Pos.Y > b.Pos.Y)
                        return 1;
                    return 0;
                }
            );
        }

        function drawPlayer(player) {
            var x = player.Pos.X;
            var y = player.Pos.Y;
            //context.filter = "drop-shadow(0px 0px 4px black)";
            context.fillStyle = "black";
            context.fillRect(x - 6, y - 19, 12, 17);
            context.fillRect(x - 8, y - 33, 16, 16); // outline
            if (player.Gender === "Female") {
                context.fillRect(x - 10, y - 33, 5, 22);  // outline
            }

            context.fillStyle = player.BodyColor;
            context.fillRect(x - 5, y - 18, 10, 15); // body
            context.fillStyle = "#fff1c1";
            context.fillRect(x - 7, y - 32, 14, 14); // face
            context.fillStyle = "black";
            context.fillRect(x - 4, y - 3, 1, 3);
            context.fillRect(x + 3, y - 3, 1, 3);    // legs
            //context.filter = "none";
            context.fillStyle = player.HairColor;
            context.fillRect(x - 7, y - 32, 14, 5);  // hair
            if (player.Gender === "Female") {
                context.fillRect(x - 9, y - 32, 3, 20);  // hair
            }
            context.fillStyle = "black";
            context.fillRect(x - 4, y - 24, 1, 2);
            context.fillRect(x + 3, y - 24, 1, 2);   // eyes

            var nameW = context.measureText(player.Name).width;
            if (player.IsMe === "True")
                context.fillStyle = "red";
            else
                context.fillStyle = "black";
            context.fillText(player.Name, x - nameW / 2, y + 15);

            if (player.Message !== null && player.Message.trim() !== "") {
                var text = player.Message;
                var textW = context.measureText(text).width;
                var textX = x - textW / 2;

                context.fillStyle = "white";
                context.fillRect(textX - 5, y - 75, textW + 10, 25);

                context.fillStyle = "black";
                context.fillText(text, textX, y - 60);

                context.beginPath();
                context.rect(textX - 5, y - 75, textW + 10, 25);
                context.stroke();
            }
        }

        function onKeyDown(event) {
            if (gameState !== "gaming")
                return;

            if (event.keyCode === 37) { // 左
                moveLeft = true;
            }else if (event.keyCode === 39) { // 右
                moveRight = true;
            }
            if (event.keyCode === 38) { // 上
                moveUp = true;
            } else if (event.keyCode === 40) { // 下
                moveDown = true;
            }

            if (event.keyCode === 13) {
                sendChat();
            }
        }

        function onKeyUp(event) {
            if (gameState !== "gaming")
                return;

            if (event.keyCode == 37) { // 左
                moveLeft = false;
            }
            if (event.keyCode == 39) { // 右
                moveRight = false;
            }
            if (event.keyCode == 38) { // 上
                moveUp = false;
            }
            if (event.keyCode == 40) { // 下
                moveDown = false;
            }
        }

        function onResize(event) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            if (gameState === "gaming")
                renderMain();
        }

        function movePlayer() {

            var myFrom = { X: myX, Y: myY };
            var myTo = {};
            var moved = false;

            if ((moveLeft || joystick.left()) && myX > 20) {
                myX -= moveSpeed;
                moved = true;
            } else if ((moveRight || joystick.right()) && myX < roomW - 20) {
                myX += moveSpeed;
                moved = true;
            }
            if ((moveUp || joystick.up()) && myY > 20) {
                myY -= moveSpeed;
                moved = true;
            } else if ((moveDown || joystick.down()) && myY < roomH - 20) {
                myY += moveSpeed;
                moved = true;
            }

            myTo = { X: myX, Y: myY };

            if (moved) {
                send({
                    Header: "Move",
                    From: myFrom,
                    To: myTo
                });
            }
        }

        function getRandomPos() {
            var minX = 20;
            var minY = 20;
            var maxX = roomW - 20;
            var maxY = roomH - 20;
            var disX = maxX - minX;
            var disY = maxY - minY;

            var randX = Math.floor(Math.random() * (disX / moveSpeed));
            var randY = Math.floor(Math.random() * (disY / moveSpeed));

            randX = randX * moveSpeed + minX;
            randY = randY * moveSpeed + minY;

            return { X: randX, Y: randY };
        }

        function getRandomColor() {
            var r = Math.floor(Math.random() * 256).toString(16).padStart(2,"0");
            var g = Math.floor(Math.random() * 256).toString(16).padStart(2,"0");
            var b = Math.floor(Math.random() * 256).toString(16).padStart(2,"0");

            return "#" + r + g + b;
        }

        function writeMessage(text) {
            $("#divHistory").append(text + '<br />');
            $("#divHistoryFrame").scrollTop($("#divHistory").height() + 50);
        }

        function send(obj) {
            socket.send(JSON.stringify(obj));
        }

    </script>
</body>
</html>